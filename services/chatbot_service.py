import uuid
import json
from typing import List, Dict, Any
from langchain_openai import ChatOpenAI
from langchain.schema import HumanMessage, SystemMessage
from core.config import settings
from core.logging import get_logger

logger = get_logger(__name__)

class ChatbotService:
    #ê³µí†µ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸
    COMMON_SYSTEM_PROMPT = """ë‹¹ì‹ ì€ ê²½í—˜ ë§ì€ ìƒë‹´ê°€ì…ë‹ˆë‹¤. 
    ì‚¬ìš©ìì˜ ê³ ë¯¼ì„ ë“£ê³  ê³µê°í•˜ë©°, ì „ë¬¸ì ì´ê³  ë”°ëœ»í•œ ì¡°ì–¸ì„ ì œê³µí•´ì£¼ì„¸ìš”.
    ê°•ë°•ì¦, ë¶ˆì•ˆ, ìš°ìš¸ ë“± ì •ì‹ ê±´ê°• ê´€ë ¨ ë¬¸ì œì— ëŒ€í•´ ì „ë¬¸ì ì¸ ê´€ì ì—ì„œ ë‹µë³€í•˜ë˜,
    í•­ìƒ ì „ë¬¸ì˜ ìƒë‹´ì„ ê¶Œì¥í•˜ëŠ” ê²ƒì„ ìŠì§€ ë§ˆì„¸ìš”."""
    
    def __init__(self):
        self.llm = ChatOpenAI(
            api_key=settings.OPENAI_API_KEY,
            model=settings.OPENAI_MODEL,
            temperature=0.7
        )

    #ì´ í•¨ìˆ˜ ì‚­ì œí•  ìˆ˜ë„ ìˆìŒ.    
    def _stringify_message_content(self, content: Any) -> str:
        """
        Normalize arbitrary message content into a readable string.
        - Lists are joined with ", ".
        - Dicts are JSON-encoded with ensure_ascii=False.
        - Others are coerced via str().
        """
        try:
            if isinstance(content, list):
                return ", ".join(str(item) for item in content)
            if isinstance(content, dict):
                return json.dumps(content, ensure_ascii=False)
            return str(content)
        except Exception:
            return str(content)
    
    def generate_obsession_question(self, user_text: str) -> Dict[str, Any]:
        """
        ì‚¬ìš©ìì˜ í…ìŠ¤íŠ¸ë¥¼ ë°”íƒ•ìœ¼ë¡œ ê°•ë°• ê´€ë ¨ ì§ˆë¬¸ê³¼ ì„ íƒì§€ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
        """
        system_prompt = """ë‹¹ì‹ ì€ ê²½í—˜ ë§ì€ ìƒë‹´ê°€ì…ë‹ˆë‹¤. 
        ì‚¬ìš©ìì˜ í…ìŠ¤íŠ¸ë¥¼ ë¶„ì„í•˜ì—¬ ê°•ë°•ì  ì‚¬ê³ ë‚˜ í–‰ë™ íŒ¨í„´ì„ íŒŒì•…í•˜ê³ , 
        ë” ê¹Šì´ ìˆëŠ” ìƒë‹´ì„ ìœ„í•œ ìì—°ìŠ¤ëŸ¬ìš´ ì§ˆë¬¸ê³¼ ì„ íƒì§€ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.
        
        **ì‘ë‹µ í˜•ì‹ (JSON):**
        {
            "question": "[ìì—°ìŠ¤ëŸ¬ìš´ ëŒ€í™”í˜• ì§ˆë¬¸]",
            "choices": ["ì„ íƒì§€1", "ì„ íƒì§€2", "ì„ íƒì§€3"]
        }
        
        **ì¤‘ìš”í•œ ê·œì¹™:**
        1. questionì€ **ìì—°ìŠ¤ëŸ½ê³  ëŒ€í™”í˜•**ìœ¼ë¡œ ë§Œë“¤ì–´ì£¼ì„¸ìš”. "~ì•Œì•„ë³´ê³  ì‹¶ìŠµë‹ˆë‹¤" ê°™ì€ í˜•ì‹ì  í‘œí˜„ì„ í”¼í•˜ì„¸ìš”.
        2. ì‚¬ìš©ìì˜ ìƒí™©ì„ ì´í•´í•˜ê³  ê³µê°í•˜ëŠ” ë“¯í•œ ì§ˆë¬¸ì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”.
        3. choicesëŠ” "~í•  ë•Œ" í˜•íƒœë¡œ 3ê°œë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”. **ì¤‘ë³µì´ë‚˜ ì–´ìƒ‰í•œ í‘œí˜„ì„ í”¼í•˜ì„¸ìš”**.
        4. ì„ íƒì§€ì—ì„œ "~ì „ì—í•  ë•Œ", "~í›„ì—í•  ë•Œ" ê°™ì€ ì¤‘ë³µ í‘œí˜„ì„ í”¼í•˜ì„¸ìš”.
        5. ì›í˜• í‘œí˜„ì„ í”¼í•˜ì„¸ìš” (ì˜ˆ: ì™„ë²½ì£¼ì˜ì— "ì™„ë²½í•¨ì„ ì¶”êµ¬í•  ë•Œ"ëŠ” ì¤‘ë³µ).
        
        **ì¢‹ì€ ì˜ˆì‹œ:**
        - ì…ë ¥: "ì†ì„ ê³„ì† ì”»ì–´ì•¼ í•œë‹¤ëŠ” ìƒê°ì´ ë“¤ì–´ìš”"
        - ì‘ë‹µ: {
            "question": "ì†ì´ ë”ëŸ½ë‹¤ê³  ëŠë‚„ ë•Œ, ë³´í†µ ì–´ë–¤ ìƒí™©ì—ì„œ ê·¸ëŸ° ìƒê°ì´ ë“œë‚˜ìš”?",
            "choices": ["ìŠ¤íŠ¸ë ˆìŠ¤ê°€ ìˆì„ ë•Œ", "íŠ¹ì • ì¥ì†Œì— ìˆì„ ë•Œ", "ë¶ˆì•ˆê°ì´ ë†’ì„ ë•Œ"]
        }
        
        - ì…ë ¥: "ë¬¸ì„ ì ê°”ëŠ”ì§€ ê³„ì† í™•ì¸í•´ì•¼ í•´ìš”"
        - ì‘ë‹µ: {
            "question": "ë¬¸ì„ ì ê°”ëŠ”ì§€ í™•ì¸í•˜ê³  ì‹¶ì„ ë•Œ, ì£¼ë¡œ ì–¸ì œ ê·¸ëŸ° ìƒê°ì´ ë“œë‚˜ìš”?",
            "choices": ["ì™¸ì¶œí•  ë•Œ", "ì ìë¦¬ì— ë“¤ ë•Œ", "ë¶ˆì•ˆê°ì´ ë†’ì„ ë•Œ"]
        }
        
        - ì…ë ¥: "ëª¨ë“  ê²ƒì´ ì™„ë²½í•´ì•¼ í•œë‹¤ëŠ” ìƒê°ì´ ë“¤ì–´ìš”"
        - ì‘ë‹µ: {
            "question": "ì™„ë²½í•´ì•¼ í•œë‹¤ê³  ëŠë‚„ ë•Œ, ì–´ë–¤ ìƒí™©ì—ì„œ ê·¸ëŸ° ì••ë°•ê°ì„ ë°›ìœ¼ì‹œë‚˜ìš”?",
            "choices": ["ìƒˆë¡œìš´ ì¼ì„ ì‹œì‘í•  ë•Œ", "ì‘ì—…ì„ ë§ˆë¬´ë¦¬í•  ë•Œ", "íƒ€ì¸ì˜ í‰ê°€ë¥¼ ë°›ì„ ë•Œ"]
        }"""
        
        user_prompt = f"ì‚¬ìš©ì í…ìŠ¤íŠ¸: {user_text}"
        
        try:
            messages = [
                SystemMessage(content=system_prompt),
                HumanMessage(content=user_prompt)
            ]
            
            response = self.llm.invoke(messages)
            response_text = response.content
            
            #JSON íŒŒì‹± ì‹œë„
            import json
            try:
                #JSON ë¶€ë¶„ë§Œ ì¶”ì¶œ
                start_idx = response_text.find('{')
                end_idx = response_text.rfind('}') + 1
                if start_idx != -1 and end_idx != -1:
                    json_str = response_text[start_idx:end_idx]
                    result = json.loads(json_str)
                    return result
            except:
                pass
            
            #JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’
            return {
                "question": f"{user_text}ì— ëŒ€í•´ ë” ìì„¸íˆ ì•Œì•„ë³´ê³  ì‹¶ìŠµë‹ˆë‹¤.",
                "choices": [
                    "ìŠ¤íŠ¸ë ˆìŠ¤ê°€ ìˆì„ ë•Œ",
                    "íŠ¹ì • ìƒí™©ì—ì„œ", 
                    "ë¶ˆì•ˆê°ì´ ë†’ì„ ë•Œ"
                ]
            }
            
        except Exception as e:
            logger.error(f"LLM í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
            return {
                "question": f"{user_text}ì— ëŒ€í•´ ë” ìì„¸íˆ ì•Œì•„ë³´ê³  ì‹¶ìŠµë‹ˆë‹¤.",
                "choices": [
                    "ìŠ¤íŠ¸ë ˆìŠ¤ê°€ ìˆì„ ë•Œ",
                    "íŠ¹ì • ìƒí™©ì—ì„œ", 
                    "ë¶ˆì•ˆê°ì´ ë†’ì„ ë•Œ"
                ]
            }
    
    def generate_obsession_analysis2_response(self, conversation_history: List[Dict[str, Any]]) -> str:
        """
        ëŒ€í™” íˆìŠ¤í† ë¦¬ë¥¼ ë¶„ì„í•˜ì—¬ ê°•ë°• í–‰ë™ì— ëŒ€í•œ ê³µê°ì  ì§ˆë¬¸ì„ ìƒì„±í•©ë‹ˆë‹¤.
        """
        system_prompt = """ë‹¹ì‹ ì€ ê²½í—˜ ë§ì€ ìƒë‹´ê°€ì…ë‹ˆë‹¤. 
        ì‚¬ìš©ìì˜ ëŒ€í™” íˆìŠ¤í† ë¦¬ë¥¼ ë¶„ì„í•˜ì—¬ ê°•ë°•ì  í–‰ë™ì´ë‚˜ ì‚¬ê³  íŒ¨í„´ì„ íŒŒì•…í•˜ê³ ,
        ê³µê°ì ì´ê³  ë”°ëœ»í•œ ì§ˆë¬¸ì„ ìƒì„±í•´ì£¼ì„¸ìš”.
        
        **ì‘ë‹µ í˜•ì‹:**
        "ë§ì”€í•´ì£¼ì…”ì„œ ê°ì‚¬í•´ìš”.
        í˜¹ì‹œ [ì‚¬ìš©ìì˜ ê°•ë°• í–‰ë™ì„ êµ¬ì²´ì ìœ¼ë¡œ ì–¸ê¸‰]í•˜ë©´ ë¶ˆí¸í–ˆë˜ ë§ˆìŒì´
        ì¢€ ë‚˜ì•„ì§€ë‚˜ìš”?"
        
        **ì¤‘ìš”í•œ ê·œì¹™:**
        1. ì‚¬ìš©ìê°€ ì–¸ê¸‰í•œ êµ¬ì²´ì ì¸ ê°•ë°• í–‰ë™ì„ íŒŒì•…í•˜ì—¬ [ ] ë¶€ë¶„ì— ë„£ì–´ì£¼ì„¸ìš”.
        2. ì˜ˆì‹œ:
           - ì‚¬ìš©ìê°€ "ì†ì´ ë”ëŸ½ë‹¤ê³  ê³„ì† ëŠë‚€ë‹¤"ê³  ë§í–ˆë‹¤ë©´ â†’ "ì†ì„ ì”»ìœ¼ë©´"
           - ì‚¬ìš©ìê°€ "ë¬¸ì„ ì ê°”ëŠ”ì§€ í™•ì¸í•œë‹¤"ê³  ë§í–ˆë‹¤ë©´ â†’ "ë¬¸ì„ í™•ì¸í•˜ë©´"
           - ì‚¬ìš©ìê°€ "ì™„ë²½í•´ì•¼ í•œë‹¤ê³  ìƒê°í•œë‹¤"ê³  ë§í–ˆë‹¤ë©´ â†’ "ì™„ë²½í•˜ê²Œ í•˜ë©´"
        3. ê³µê°ì ì´ê³  ë”°ëœ»í•œ í†¤ì„ ìœ ì§€í•˜ì„¸ìš”.
        4. ê°•ë°• í–‰ë™ì„ ë¶€ì •ì ìœ¼ë¡œ í‘œí˜„í•˜ì§€ ë§ê³ , ì¤‘ë¦½ì ìœ¼ë¡œ í‘œí˜„í•˜ì„¸ìš”."""
        
        #ëŒ€í™” íˆìŠ¤í† ë¦¬ì—ì„œ ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ì¶œ
        user_messages = []
        for msg in conversation_history:
            if msg.get("role") == "user":
                content = msg.get("content", "")
                user_messages.append(self._stringify_message_content(content))
        
        #ìµœê·¼ ì‚¬ìš©ì ë©”ì‹œì§€ë“¤ì„ í•˜ë‚˜ì˜ í…ìŠ¤íŠ¸ë¡œ ê²°í•©
        recent_context = " ".join(user_messages[-3:])  #ìµœê·¼ 3ê°œ ë©”ì‹œì§€ë§Œ ì‚¬ìš©
        
        user_prompt = f"ëŒ€í™” íˆìŠ¤í† ë¦¬: {recent_context}"
        
        try:
            messages = [
                SystemMessage(content=system_prompt),
                HumanMessage(content=user_prompt)
            ]
            
            response = self.llm.invoke(messages)
            return response.content.strip()
            
        except Exception as e:
            logger.error(f"ê°•ë°• ë¶„ì„2 ì‘ë‹µ ìƒì„± ì¤‘ ì˜¤ë¥˜: {e}")
            return "ë§ì”€í•´ì£¼ì…”ì„œ ê°ì‚¬í•´ìš”.\ní˜¹ì‹œ ê·¸ëŸ° í–‰ë™ì„ í•˜ë©´ ë¶ˆí¸í–ˆë˜ ë§ˆìŒì´\nì¢€ ë‚˜ì•„ì§€ë‚˜ìš”?"
    
    def generate_obsession_analysis3_response(self, conversation_history: List[Dict[str, Any]]) -> Dict[str, Any]:
        """
        ëŒ€í™” íˆìŠ¤í† ë¦¬ë¥¼ ë¶„ì„í•˜ì—¬ ê°•ë°• íŒ¨í„´ ìš”ì•½ê³¼ ìƒê° ì˜ˆì‹œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
        """
        system_prompt = """ë‹¹ì‹ ì€ ê²½í—˜ ë§ì€ ìƒë‹´ê°€ì…ë‹ˆë‹¤. 
        ì‚¬ìš©ìì˜ ëŒ€í™” íˆìŠ¤í† ë¦¬ë¥¼ ë¶„ì„í•˜ì—¬ ê°•ë°•ì  ì‚¬ê³ ë‚˜ í–‰ë™ íŒ¨í„´ì„ íŒŒì•…í•˜ê³ ,
        ì‚¬ìš©ìì˜ íŒ¨í„´ì„ ìš”ì•½í•˜ê³  ê´€ë ¨ëœ ìƒê° ì˜ˆì‹œë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.
        
        **ì‘ë‹µ í˜•ì‹ (JSON):**
        {
            "user_pattern_summary": "ë‹¹ì‹ ì€ [êµ¬ì²´ì ì¸ ê°•ë°• íŒ¨í„´]í•˜ëŠ” ê²½í–¥ì´ ìˆëŠ” ê²ƒ ê°™ì•„ìš”.",
            "thought_examples": [
                "ìƒê° ì˜ˆì‹œ 1",
                "ìƒê° ì˜ˆì‹œ 2", 
                "ìƒê° ì˜ˆì‹œ 3"
            ]
        }
        
        **ì¤‘ìš”í•œ ê·œì¹™:**
        1. user_pattern_summaryëŠ” ì‚¬ìš©ìê°€ ì–¸ê¸‰í•œ êµ¬ì²´ì ì¸ ê°•ë°• í–‰ë™ì„ ë°”íƒ•ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.
        2. ì˜ˆì‹œ:
           - ì† ì”»ê¸° ê°•ë°•: "ë‹¹ì‹ ì€ ì†ì´ ì˜¤ì—¼ëì„ ê²ƒ ê°™ë‹¤ëŠ” ë¶ˆì•ˆì´ ìì£¼ ë“¤ê³ , ê·¸ ë¶ˆì•ˆì„ ì¤„ì´ê¸° ìœ„í•´ ì† ì”»ê¸°ë¥¼ ë°˜ë³µí•˜ëŠ” ê²½í–¥ì´ ìˆëŠ” ê²ƒ ê°™ì•„ìš”."
           - í™•ì¸ ê°•ë°•: "ë‹¹ì‹ ì€ ë¬¸ì„ ì œëŒ€ë¡œ ì ê°”ëŠ”ì§€, ê°€ìŠ¤ë¥¼ ë„ì§€ ì•Šì•˜ëŠ”ì§€ ê±±ì •ì´ ë˜ì–´ ë°˜ë³µì ìœ¼ë¡œ í™•ì¸í•˜ëŠ” ê²½í–¥ì´ ìˆëŠ” ê²ƒ ê°™ì•„ìš”."
           - ì™„ë²½ì£¼ì˜: "ë‹¹ì‹ ì€ ëª¨ë“  ê²ƒì„ ì™„ë²½í•˜ê²Œ í•´ì•¼ í•œë‹¤ëŠ” ì••ë°•ê°ì„ ëŠë¼ê³ , ì‹¤ìˆ˜ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ ë°˜ë³µì ìœ¼ë¡œ í™•ì¸í•˜ëŠ” ê²½í–¥ì´ ìˆëŠ” ê²ƒ ê°™ì•„ìš”."
        3. thought_examplesëŠ” í•´ë‹¹ ê°•ë°•ê³¼ ê´€ë ¨ëœ êµ¬ì²´ì ì¸ ìƒê° 3ê°œë¥¼ ìƒì„±í•˜ì„¸ìš”.
        4. ìƒê° ì˜ˆì‹œëŠ” ì‹¤ì œë¡œ ê°•ë°•ì„ ê²½í—˜í•˜ëŠ” ì‚¬ëŒì´ ê°€ì§ˆ ë²•í•œ í˜„ì‹¤ì ì¸ ìƒê°ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”."""
        
        #ëŒ€í™” íˆìŠ¤í† ë¦¬ì—ì„œ ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ì¶œ
        user_messages = []
        for msg in conversation_history:
            if msg.get("role") == "user":
                content = msg.get("content", "")
                user_messages.append(self._stringify_message_content(content))
        
        #ìµœê·¼ ì‚¬ìš©ì ë©”ì‹œì§€ë“¤ì„ í•˜ë‚˜ì˜ í…ìŠ¤íŠ¸ë¡œ ê²°í•©
        recent_context = " ".join(user_messages[-5:])  #ìµœê·¼ 5ê°œ ë©”ì‹œì§€ ì‚¬ìš©
        
        user_prompt = f"ëŒ€í™” íˆìŠ¤í† ë¦¬: {recent_context}"
        
        try:
            messages = [
                SystemMessage(content=system_prompt),
                HumanMessage(content=user_prompt)
            ]
            
            response = self.llm.invoke(messages)
            response_text = response.content
            
            #JSON íŒŒì‹± ì‹œë„
            import json
            try:
                #JSON ë¶€ë¶„ë§Œ ì¶”ì¶œ
                start_idx = response_text.find('{')
                end_idx = response_text.rfind('}') + 1
                if start_idx != -1 and end_idx != -1:
                    json_str = response_text[start_idx:end_idx]
                    result = json.loads(json_str)
                    return result
            except:
                pass
            
            #JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’
            return {
                "user_pattern_summary": "ë‹¹ì‹ ì€ ë¶ˆì•ˆê°ì„ ì¤„ì´ê¸° ìœ„í•´ ë°˜ë³µì ì¸ í–‰ë™ì„ í•˜ëŠ” ê²½í–¥ì´ ìˆëŠ” ê²ƒ ê°™ì•„ìš”.",
                "thought_examples": [
                    "ì´ê²ƒì„ í•˜ì§€ ì•Šìœ¼ë©´ ë‚˜ìœ ì¼ì´ ì¼ì–´ë‚  ê²ƒ ê°™ì•„",
                    "í™•ì¸í•˜ì§€ ì•Šìœ¼ë©´ ë¶ˆì•ˆí•´ì ¸",
                    "ì™„ë²½í•˜ì§€ ì•Šìœ¼ë©´ ì‹¤íŒ¨í•  ê²ƒ ê°™ì•„"
                ]
            }
            
        except Exception as e:
            logger.error(f"ê°•ë°• ë¶„ì„3 ì‘ë‹µ ìƒì„± ì¤‘ ì˜¤ë¥˜: {e}")
            return {
                "user_pattern_summary": "ë‹¹ì‹ ì€ ë¶ˆì•ˆê°ì„ ì¤„ì´ê¸° ìœ„í•´ ë°˜ë³µì ì¸ í–‰ë™ì„ í•˜ëŠ” ê²½í–¥ì´ ìˆëŠ” ê²ƒ ê°™ì•„ìš”.",
                "thought_examples": [
                    "ì´ê²ƒì„ í•˜ì§€ ì•Šìœ¼ë©´ ë‚˜ìœ ì¼ì´ ì¼ì–´ë‚  ê²ƒ ê°™ì•„",
                    "í™•ì¸í•˜ì§€ ì•Šìœ¼ë©´ ë¶ˆì•ˆí•´ì ¸",
                    "ì™„ë²½í•˜ì§€ ì•Šìœ¼ë©´ ì‹¤íŒ¨í•  ê²ƒ ê°™ì•„"
                ]
            }

    def categorize_obsession_type(self, conversation_history: List[Dict[str, Any]]) -> str:
        """
        ëŒ€í™” íˆìŠ¤í† ë¦¬ë¥¼ ë¶„ì„í•˜ì—¬ ê°•ë°• ìœ í˜•ì„ ì¹´í…Œê³ ë¦¬í™”í•©ë‹ˆë‹¤.
        ë°˜í™˜ê°’: "contamination" (ì˜¤ì—¼ê°•ë°•), "checking" (í™•ì¸ê°•ë°•), "other" (ê·¸ ì™¸ ê°•ë°•)
        """
        system_prompt = """ë‹¹ì‹ ì€ ê°•ë°•ì¦ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. 
        ì‚¬ìš©ìì˜ ëŒ€í™” íˆìŠ¤í† ë¦¬ë¥¼ ë¶„ì„í•˜ì—¬ ê°•ë°• ìœ í˜•ì„ ë¶„ë¥˜í•´ì£¼ì„¸ìš”.
        
        **ë¶„ë¥˜ ê¸°ì¤€:**
        1. ì˜¤ì—¼ê°•ë°• (contamination): 
           - ì† ì”»ê¸°, ì²­ì†Œ, ì˜¤ì—¼ì— ëŒ€í•œ ë¶ˆì•ˆ
           - ì„¸ê· , ë°”ì´ëŸ¬ìŠ¤, ë”ëŸ¬ì›€ì— ëŒ€í•œ ë‘ë ¤ì›€
           - ì˜ˆ: "ì†ì´ ë”ëŸ½ë‹¤ê³  ëŠê»´ì„œ ê³„ì† ì”»ì–´ì•¼ í•´ìš”", "ì„¸ê· ì´ ë¬´ì„œì›Œìš”"
        
        2. í™•ì¸ê°•ë°• (checking):
           - ë¬¸ ì ê¸ˆ, ê°€ìŠ¤ ë„ê¸°, ì „ìì œí’ˆ í™•ì¸
           - ì•ˆì „ì— ëŒ€í•œ ë°˜ë³µì  í™•ì¸
           - ì˜ˆ: "ë¬¸ì„ ì ê°”ëŠ”ì§€ ê³„ì† í™•ì¸í•´ìš”", "ê°€ìŠ¤ë¥¼ ë„ì§€ ì•Šì•˜ë‚˜ ê±±ì •ë¼ìš”"
        
        3. ê·¸ ì™¸ ê°•ë°• (other):
           - ì™„ë²½ì£¼ì˜, ìˆœì„œ/ì •ë¦¬ ê°•ë°•, ìˆ˜ì§‘ ê°•ë°• ë“±
           - ìœ„ ë‘ ì¹´í…Œê³ ë¦¬ì— í•´ë‹¹í•˜ì§€ ì•ŠëŠ” ëª¨ë“  ê°•ë°•
           - ì˜ˆ: "ëª¨ë“  ê²ƒì´ ì™„ë²½í•´ì•¼ í•´ìš”", "ì •í•´ì§„ ìˆœì„œëŒ€ë¡œ í•´ì•¼ í•´ìš”"
        
        **ì‘ë‹µ í˜•ì‹:**
        ë°˜ë“œì‹œ ë‹¤ìŒ ì¤‘ í•˜ë‚˜ë§Œ ì •í™•íˆ ë°˜í™˜í•˜ì„¸ìš”:
        - "contamination"
        - "checking" 
        - "other"
        
        **ì¤‘ìš”í•œ ê·œì¹™:**
        1. ì‚¬ìš©ìê°€ ì–¸ê¸‰í•œ êµ¬ì²´ì ì¸ ê°•ë°• í–‰ë™ì„ ë°”íƒ•ìœ¼ë¡œ íŒë‹¨í•˜ì„¸ìš”.
        2. ì• ë§¤í•œ ê²½ìš°ì—ëŠ” "other"ë¡œ ë¶„ë¥˜í•˜ì„¸ìš”.
        3. ë°˜ë“œì‹œ ìœ„ 3ê°œ ê°’ ì¤‘ í•˜ë‚˜ë§Œ ë°˜í™˜í•˜ì„¸ìš”."""
        
        # ëŒ€í™” íˆìŠ¤í† ë¦¬ì—ì„œ ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ì¶œ
        user_messages = []
        for msg in conversation_history:
            if msg.get("role") == "user":
                content = msg.get("content", "")
                user_messages.append(self._stringify_message_content(content))
        
        # ìµœê·¼ ì‚¬ìš©ì ë©”ì‹œì§€ë“¤ì„ í•˜ë‚˜ì˜ í…ìŠ¤íŠ¸ë¡œ ê²°í•©
        recent_context = " ".join(user_messages[-5:])  # ìµœê·¼ 5ê°œ ë©”ì‹œì§€ ì‚¬ìš©
        
        user_prompt = f"ëŒ€í™” íˆìŠ¤í† ë¦¬: {recent_context}"
        
        try:
            messages = [
                SystemMessage(content=system_prompt),
                HumanMessage(content=user_prompt)
            ]
            
            response = self.llm.invoke(messages)
            category = response.content.strip().lower()
            
            # ìœ íš¨í•œ ì¹´í…Œê³ ë¦¬ì¸ì§€ í™•ì¸
            if category in ["contamination", "checking", "other"]:
                return category
            else:
                logger.warning(f"ì˜ˆìƒì¹˜ ëª»í•œ ì¹´í…Œê³ ë¦¬ ë°˜í™˜: {category}, ê¸°ë³¸ê°’ 'other' ì‚¬ìš©")
                return "other"
                
        except Exception as e:
            logger.error(f"ê°•ë°• ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜ ì¤‘ ì˜¤ë¥˜: {e}")
            return "other"

    def generate_obsession_analysis4_response(self, conversation_history: List[Dict[str, Any]]) -> Dict[str, Any]:
        """
        ëŒ€í™” íˆìŠ¤í† ë¦¬ë¥¼ ë¶„ì„í•˜ì—¬ ê°•ë°• ìœ í˜•ë³„ ë§ì¶¤ ì‘ë‹µì„ ìƒì„±í•©ë‹ˆë‹¤.
        """
        # 1ë‹¨ê³„: ê°•ë°• ìœ í˜• ì¹´í…Œê³ ë¦¬í™”
        obsession_type = self.categorize_obsession_type(conversation_history)
        
        # 2ë‹¨ê³„: ì¹´í…Œê³ ë¦¬ë³„ ì‹œë‚˜ë¦¬ì˜¤ì— ë”°ë¥¸ ì‘ë‹µ ìƒì„±
        response_data = self._generate_category_specific_response(conversation_history, obsession_type)
        
        return response_data

    def _generate_category_specific_response(self, conversation_history: List[Dict[str, Any]], obsession_type: str) -> Dict[str, Any]:
        """
        ê°•ë°• ìœ í˜•ì— ë”°ë¥¸ ë§ì¶¤ ì‘ë‹µì„ ìƒì„±í•©ë‹ˆë‹¤.
        """
        # ëŒ€í™” íˆìŠ¤í† ë¦¬ì—ì„œ ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ì¶œ
        user_messages = []
        for msg in conversation_history:
            if msg.get("role") == "user":
                content = msg.get("content", "")
                user_messages.append(self._stringify_message_content(content))
        
        recent_context = " ".join(user_messages[-5:])
        
        if obsession_type == "contamination":
            # ì˜¤ì—¼ê°•ë°• ì‹œë‚˜ë¦¬ì˜¤
            system_prompt = """ë‹¹ì‹ ì€ ê²½í—˜ ë§ì€ ìƒë‹´ê°€ì…ë‹ˆë‹¤. 
            ì‚¬ìš©ìì˜ ì˜¤ì—¼ê°•ë°• ê´€ë ¨ ëŒ€í™”ë¥¼ ë¶„ì„í•˜ì—¬ ê³µê°ì ì´ê³  ë„ì›€ì´ ë˜ëŠ” ì‘ë‹µì„ ìƒì„±í•´ì£¼ì„¸ìš”.
            
            **ì‘ë‹µ êµ¬ì„±:**
            1. ê³µê°ê³¼ ì´í•´ í‘œí˜„
            2. ì˜¤ì—¼ì— ëŒ€í•œ ë¶ˆì•ˆì— ëŒ€í•œ ì„¤ëª…
            3. ì¼ìƒìƒí™œ ë°©í•´ ì‹œ ì‹ í˜¸ì— ëŒ€í•œ ì–¸ê¸‰
            4. ì—°ìŠµì´ í•„ìš”í•˜ë‹¤ëŠ” ì•ˆë‚´
            
            **ì‘ë‹µ í˜•ì‹:**
            "ë§ì•„ìš”. ëˆ„êµ¬ë‚˜ ê·¸ëŸ° ìƒê°ì„ í•  ìˆ˜ ìˆì–´ìš”.
            í•˜ì§€ë§Œ ì´ëŸ° ìƒê°ì´ ë„ˆë¬´ ìì£¼ ë– ì˜¤ë¥´ê±°ë‚˜,
            ë°˜ë³µë˜ëŠ” í–‰ë™(ì˜ˆ: ì† ì”»ê¸°)ì´ ì¼ìƒìƒí™œì„
            ë°©í•´í•œë‹¤ë©´ ê·¸ê±´ 'ì˜¤ì—¼ì— ëŒ€í•œ ë¶ˆì•ˆ'ì„ ë‹¤ë£¨ëŠ”
            ì—°ìŠµì´ í•„ìš”í•˜ë‹¤ëŠ” ì‹ í˜¸ì¼ ìˆ˜ ìˆì–´ìš”."
            
            **ì¤‘ìš”í•œ ê·œì¹™:**
            1. ê³µê°ì ì´ê³  ë”°ëœ»í•œ í†¤ì„ ìœ ì§€í•˜ì„¸ìš”.
            2. ì‚¬ìš©ìì˜ êµ¬ì²´ì ì¸ ìƒí™©ì„ ë°˜ì˜í•˜ì—¬ ìì—°ìŠ¤ëŸ½ê²Œ ì‘ì„±í•˜ì„¸ìš”.
            3. ìœ„ í˜•ì‹ì„ ê¸°ë³¸ìœ¼ë¡œ í•˜ë˜, ì‚¬ìš©ì ìƒí™©ì— ë§ê²Œ ì¡°ì •í•˜ì„¸ìš”.
            4. í•œê¸€ ê¸°ì¤€ ì´ ê¸¸ì´ë¥¼ 200ì ì´ë‚´ë¡œ ì‘ì„±í•˜ì„¸ìš”.
            5. 'ì˜¤ì—¼ ê°•ë°•', 'í™•ì¸ ê°•ë°•', 'ê°•ë°•ì¦', 'OCD' ê°™ì€ ëª…ì¹­/ì§„ë‹¨/ìœ í˜• ë¼ë²¨ì€ ì–¸ê¸‰í•˜ì§€ ë§ˆì„¸ìš”. í–‰ë™ê³¼ ê²½í—˜ë§Œ ìì—°ìŠ¤ëŸ½ê²Œ ë¬˜ì‚¬í•˜ì„¸ìš”."""
            
        elif obsession_type == "checking":
            # í™•ì¸ê°•ë°• ì‹œë‚˜ë¦¬ì˜¤
            system_prompt = """ë‹¹ì‹ ì€ ê²½í—˜ ë§ì€ ìƒë‹´ê°€ì…ë‹ˆë‹¤. 
            ì‚¬ìš©ìì˜ í™•ì¸ê°•ë°• ê´€ë ¨ ëŒ€í™”ë¥¼ ë¶„ì„í•˜ì—¬ ê³µê°ì ì´ê³  ë„ì›€ì´ ë˜ëŠ” ì‘ë‹µì„ ìƒì„±í•´ì£¼ì„¸ìš”.
            
            **ì‘ë‹µ êµ¬ì„±:**
            1. ê³µê°ê³¼ ì´í•´ í‘œí˜„
            2. í™•ì¸ì— ëŒ€í•œ ë¶ˆì•ˆì— ëŒ€í•œ ì„¤ëª…
            3. ì¼ìƒìƒí™œ ë°©í•´ ì‹œ ì‹ í˜¸ì— ëŒ€í•œ ì–¸ê¸‰
            4. ì—°ìŠµì´ í•„ìš”í•˜ë‹¤ëŠ” ì•ˆë‚´
            
            **ì‘ë‹µ í˜•ì‹:**
            "ë§ì•„ìš”. ëˆ„êµ¬ë‚˜ ê·¸ëŸ° ìƒê°ì„ í•  ìˆ˜ ìˆì–´ìš”.
            í•˜ì§€ë§Œ ì´ëŸ° ìƒê°ì´ ë„ˆë¬´ ìì£¼ ë– ì˜¤ë¥´ê±°ë‚˜,
            ë°˜ë³µë˜ëŠ” í–‰ë™(ì˜ˆ: í™•ì¸í•˜ê¸°)ì´ ì¼ìƒìƒí™œì„
            ë°©í•´í•œë‹¤ë©´ ê·¸ê±´ 'í™•ì¸ì— ëŒ€í•œ ë¶ˆì•ˆ'ì„ ë‹¤ë£¨ëŠ”
            ì—°ìŠµì´ í•„ìš”í•˜ë‹¤ëŠ” ì‹ í˜¸ì¼ ìˆ˜ ìˆì–´ìš”."
            
            **ì¤‘ìš”í•œ ê·œì¹™:**
            1. ê³µê°ì ì´ê³  ë”°ëœ»í•œ í†¤ì„ ìœ ì§€í•˜ì„¸ìš”.
            2. ì‚¬ìš©ìì˜ êµ¬ì²´ì ì¸ ìƒí™©ì„ ë°˜ì˜í•˜ì—¬ ìì—°ìŠ¤ëŸ½ê²Œ ì‘ì„±í•˜ì„¸ìš”.
            3. ìœ„ í˜•ì‹ì„ ê¸°ë³¸ìœ¼ë¡œ í•˜ë˜, ì‚¬ìš©ì ìƒí™©ì— ë§ê²Œ ì¡°ì •í•˜ì„¸ìš”.
            4. í•œê¸€ ê¸°ì¤€ ì´ ê¸¸ì´ë¥¼ 200ì ì´ë‚´ë¡œ ì‘ì„±í•˜ì„¸ìš”.
            5. 'ì˜¤ì—¼ ê°•ë°•', 'í™•ì¸ ê°•ë°•', 'ê°•ë°•ì¦', 'OCD' ê°™ì€ ëª…ì¹­/ì§„ë‹¨/ìœ í˜• ë¼ë²¨ì€ ì–¸ê¸‰í•˜ì§€ ë§ˆì„¸ìš”. í–‰ë™ê³¼ ê²½í—˜ë§Œ ìì—°ìŠ¤ëŸ½ê²Œ ë¬˜ì‚¬í•˜ì„¸ìš”."""
            
        else:  # other
            # ê·¸ ì™¸ ê°•ë°• ì‹œë‚˜ë¦¬ì˜¤
            system_prompt = """ë‹¹ì‹ ì€ ê²½í—˜ ë§ì€ ìƒë‹´ê°€ì…ë‹ˆë‹¤. 
            ì‚¬ìš©ìì˜ ê°•ë°• ê´€ë ¨ ëŒ€í™”ë¥¼ ë¶„ì„í•˜ì—¬ ê³µê°ì ì´ê³  ë„ì›€ì´ ë˜ëŠ” ì‘ë‹µì„ ìƒì„±í•´ì£¼ì„¸ìš”.
            
            **ì‘ë‹µ êµ¬ì„±:**
            1. ê³µê°ê³¼ ì´í•´ í‘œí˜„
            2. ê°•ë°•ì— ëŒ€í•œ ì¼ë°˜ì ì¸ ì„¤ëª…
            3. ì¼ìƒìƒí™œ ë°©í•´ ì‹œ ì‹ í˜¸ì— ëŒ€í•œ ì–¸ê¸‰
            4. ì—°ìŠµì´ í•„ìš”í•˜ë‹¤ëŠ” ì•ˆë‚´
            
            **ì‘ë‹µ í˜•ì‹:**
            "ë§ì•„ìš”. ëˆ„êµ¬ë‚˜ ê·¸ëŸ° ìƒê°ì„ í•  ìˆ˜ ìˆì–´ìš”.
            í•˜ì§€ë§Œ ì´ëŸ° ìƒê°ì´ ë„ˆë¬´ ìì£¼ ë– ì˜¤ë¥´ê±°ë‚˜,
            ë°˜ë³µë˜ëŠ” í–‰ë™ì´ ì¼ìƒìƒí™œì„
            ë°©í•´í•œë‹¤ë©´ ê·¸ê±´ 'ê°•ë°•ì  ë¶ˆì•ˆ'ì„ ë‹¤ë£¨ëŠ”
            ì—°ìŠµì´ í•„ìš”í•˜ë‹¤ëŠ” ì‹ í˜¸ì¼ ìˆ˜ ìˆì–´ìš”."
            
            **ì¤‘ìš”í•œ ê·œì¹™:**
            1. ê³µê°ì ì´ê³  ë”°ëœ»í•œ í†¤ì„ ìœ ì§€í•˜ì„¸ìš”.
            2. ì‚¬ìš©ìì˜ êµ¬ì²´ì ì¸ ìƒí™©ì„ ë°˜ì˜í•˜ì—¬ ìì—°ìŠ¤ëŸ½ê²Œ ì‘ì„±í•˜ì„¸ìš”.
            3. ìœ„ í˜•ì‹ì„ ê¸°ë³¸ìœ¼ë¡œ í•˜ë˜, ì‚¬ìš©ì ìƒí™©ì— ë§ê²Œ ì¡°ì •í•˜ì„¸ìš”.
            4. í•œê¸€ ê¸°ì¤€ ì´ ê¸¸ì´ë¥¼ 200ì ì´ë‚´ë¡œ ì‘ì„±í•˜ì„¸ìš”.
            5. 'ì˜¤ì—¼ ê°•ë°•', 'í™•ì¸ ê°•ë°•', 'ê°•ë°•ì¦', 'OCD' ê°™ì€ ëª…ì¹­/ì§„ë‹¨/ìœ í˜• ë¼ë²¨ì€ ì–¸ê¸‰í•˜ì§€ ë§ˆì„¸ìš”. í–‰ë™ê³¼ ê²½í—˜ë§Œ ìì—°ìŠ¤ëŸ½ê²Œ ë¬˜ì‚¬í•˜ì„¸ìš”."""
        
        user_prompt = f"ëŒ€í™” íˆìŠ¤í† ë¦¬: {recent_context}"
        
        try:
            messages = [
                SystemMessage(content=system_prompt),
                HumanMessage(content=user_prompt)
            ]
            
            response = self.llm.invoke(messages)
            llm_response = response.content.strip()
            
            # ì¹´í…Œê³ ë¦¬ë³„ ê³ ì • ë©”ì‹œì§€ ìƒì„±
            if obsession_type == "contamination":
                category_message = "ì§€ê¸ˆ ë‹¹ì‹ ì´ ì´ì•¼ê¸°í•´ì£¼ì‹  ë¶ˆí¸í•¨ì€, 'ì˜¤ì—¼ ê°•ë°•'ì´ë¼ê³  ë¶ˆë¦¬ëŠ” ê°•ë°•ì¦ì˜ í•œ ìœ í˜•ê³¼ ë¹„ìŠ·í•œ ëª¨ìŠµì´ì—ìš”."
                encouragement = "í•˜ì§€ë§Œ ê±±ì •í•˜ì§€ ë§ˆì„¸ìš”. ì´ë¥¼ ì¸ì‹í•˜ê³ , ì¡°ê¸ˆì”© ë‹¤ë£¨ëŠ” ì—°ìŠµì„ í•´ë³¼ ìˆ˜ ìˆì–´ìš”. ì œê°€ ê·¸ ê³¼ì •ì„ ë„ì™€ë“œë¦´ê²Œìš” ğŸ˜Š"
            elif obsession_type == "checking":
                category_message = "ì§€ê¸ˆ ë‹¹ì‹ ì´ ì´ì•¼ê¸°í•´ì£¼ì‹  ë¶ˆí¸í•¨ì€, 'í™•ì¸ ê°•ë°•'ì´ë¼ê³  ë¶ˆë¦¬ëŠ” ê°•ë°•ì¦ì˜ í•œ ìœ í˜•ê³¼ ë¹„ìŠ·í•œ ëª¨ìŠµì´ì—ìš”."
                encouragement = "í•˜ì§€ë§Œ ê±±ì •í•˜ì§€ ë§ˆì„¸ìš”. ì´ë¥¼ ì¸ì‹í•˜ê³ , ì¡°ê¸ˆì”© ë‹¤ë£¨ëŠ” ì—°ìŠµì„ í•´ë³¼ ìˆ˜ ìˆì–´ìš”. ì œê°€ ê·¸ ê³¼ì •ì„ ë„ì™€ë“œë¦´ê²Œìš” ğŸ˜Š"
            else:  # other
                category_message = "ì•„ì‰½ê²Œë„ ì €í¬ Mindit ì„œë¹„ìŠ¤ì—ì„œëŠ” ì–¸ê¸‰í•´ì£¼ì‹  ê°•ë°•ì— ë„ì›€ì„ ë“œë¦´ ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì´ ì—†ì–´ìš”."
                encouragement = "í•˜ì§€ë§Œ ê±±ì •í•˜ì§€ ë§ˆì„¸ìš”. ì „ë¬¸ê¸°ê´€ì— ë°©ë¬¸í•˜ì—¬ ìƒë‹´ ë°›ìœ¼ì‹ ë‹¤ë©´, ê¸ˆë°© í•´ê²°í•´ë‚˜ê°€ì‹¤ ìˆ˜ ìˆì„ ê±°ì˜ˆìš”. ì‚¬ìš©ìë¶„ì˜ ì—¬ì •ì„ ì‘ì›í•©ë‹ˆë‹¤."
            
            return {
                "user_pattern_summary": llm_response,
                "encouragement": encouragement,
                "category_message": category_message,
                "obsession_type": obsession_type
            }
            
        except Exception as e:
            logger.error(f"ì¹´í…Œê³ ë¦¬ë³„ ì‘ë‹µ ìƒì„± ì¤‘ ì˜¤ë¥˜: {e}")
            # ê¸°ë³¸ê°’ ë°˜í™˜
            if obsession_type == "contamination":
                category_message = "ì§€ê¸ˆ ë‹¹ì‹ ì´ ì´ì•¼ê¸°í•´ì£¼ì‹  ë¶ˆí¸í•¨ì€, 'ì˜¤ì—¼ ê°•ë°•'ì´ë¼ê³  ë¶ˆë¦¬ëŠ” ê°•ë°•ì¦ì˜ í•œ ìœ í˜•ê³¼ ë¹„ìŠ·í•œ ëª¨ìŠµì´ì—ìš”."
            elif obsession_type == "checking":
                category_message = "ì§€ê¸ˆ ë‹¹ì‹ ì´ ì´ì•¼ê¸°í•´ì£¼ì‹  ë¶ˆí¸í•¨ì€, 'í™•ì¸ ê°•ë°•'ì´ë¼ê³  ë¶ˆë¦¬ëŠ” ê°•ë°•ì¦ì˜ í•œ ìœ í˜•ê³¼ ë¹„ìŠ·í•œ ëª¨ìŠµì´ì—ìš”."
            else:
                category_message = "ì•„ì‰½ê²Œë„ ì €í¬ Mindit ì„œë¹„ìŠ¤ì—ì„œëŠ” ì–¸ê¸‰í•´ì£¼ì‹  ê°•ë°•ì— ë„ì›€ì„ ë“œë¦´ ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì´ ì—†ì–´ìš”."
            
            return {
                "user_pattern_summary": "ë§ì•„ìš”. ëˆ„êµ¬ë‚˜ ê·¸ëŸ° ìƒê°ì„ í•  ìˆ˜ ìˆì–´ìš”. í•˜ì§€ë§Œ ì´ëŸ° ìƒê°ì´ ë„ˆë¬´ ìì£¼ ë– ì˜¤ë¥´ê±°ë‚˜, ë°˜ë³µë˜ëŠ” í–‰ë™ì´ ì¼ìƒìƒí™œì„ ë°©í•´í•œë‹¤ë©´ ê·¸ê±´ ê°•ë°•ì  ë¶ˆì•ˆì„ ë‹¤ë£¨ëŠ” ì—°ìŠµì´ í•„ìš”í•˜ë‹¤ëŠ” ì‹ í˜¸ì¼ ìˆ˜ ìˆì–´ìš”.",
                "encouragement": "í•˜ì§€ë§Œ ê±±ì •í•˜ì§€ ë§ˆì„¸ìš”. ì´ë¥¼ ì¸ì‹í•˜ê³ , ì¡°ê¸ˆì”© ë‹¤ë£¨ëŠ” ì—°ìŠµì„ í•´ë³¼ ìˆ˜ ìˆì–´ìš”. ì œê°€ ê·¸ ê³¼ì •ì„ ë„ì™€ë“œë¦´ê²Œìš” ğŸ˜Š" if obsession_type != "other" else "í•˜ì§€ë§Œ ê±±ì •í•˜ì§€ ë§ˆì„¸ìš”. ì „ë¬¸ê¸°ê´€ì— ë°©ë¬¸í•˜ì—¬ ìƒë‹´ ë°›ìœ¼ì‹ ë‹¤ë©´, ê¸ˆë°© í•´ê²°í•´ë‚˜ê°€ì‹¤ ìˆ˜ ìˆì„ ê±°ì˜ˆìš”. ì‚¬ìš©ìë¶„ì˜ ì—¬ì •ì„ ì‘ì›í•©ë‹ˆë‹¤.",
                "category_message": category_message,
                "obsession_type": obsession_type
            }

    def generate_chat_response(self, message: str, conversation_history: List[Dict] = None) -> str:
        """
        ì¼ë°˜ì ì¸ ì±„íŒ… ì‘ë‹µì„ ìƒì„±í•©ë‹ˆë‹¤.
        """
        messages = [SystemMessage(content=self.COMMON_SYSTEM_PROMPT)]
        
        #ëŒ€í™” íˆìŠ¤í† ë¦¬ê°€ ìˆë‹¤ë©´ ì¶”ê°€
        if conversation_history:
            for hist in conversation_history[-5:]:  #ìµœê·¼ 5ê°œ ë©”ì‹œì§€ë§Œ ì‚¬ìš©
                if hist.get("role") == "user":
                    messages.append(HumanMessage(content=hist.get("content", "")))
                elif hist.get("role") == "assistant":
                    messages.append(SystemMessage(content=hist.get("content", "")))
        
        messages.append(HumanMessage(content=message))
        
        try:
            response = self.llm.invoke(messages)
            return response.content
        except Exception as e:
            logger.error(f"ì±„íŒ… ì‘ë‹µ ìƒì„± ì¤‘ ì˜¤ë¥˜: {e}")
            return "ì£„ì†¡í•©ë‹ˆë‹¤. ì¼ì‹œì ì¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."

    def generate_obsession_analysis5_response(self, conversation_history: List[Dict[str, Any]]) -> str:
        """
        ëŒ€í™” íˆìŠ¤í† ë¦¬ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‚¬ìš©ìê°€ ìŠ¤ìŠ¤ë¡œ íŒ¨í„´ì„ ìê°í•˜ë„ë¡ ë•ëŠ”
        ê³µê°ì  ë°˜ì¶” ì§ˆë¬¸ì„ í•œêµ­ì–´ë¡œ ìƒì„±í•©ë‹ˆë‹¤.
        """
        system_prompt = """ë‹¹ì‹ ì€ ê²½í—˜ ë§ì€ ìƒë‹´ê°€ì…ë‹ˆë‹¤.
        ì‚¬ìš©ìì˜ ìµœê·¼ ëŒ€í™”ë¥¼ ë°”íƒ•ìœ¼ë¡œ, ì‚¬ìš©ìê°€ ìŠ¤ìŠ¤ë¡œ íŒ¨í„´ì„ ì•Œì•„ì°¨ë¦¬ë„ë¡ ë•ëŠ” ë¬¸ì¥ì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”.

        ê·œì¹™: ì˜ˆì‹œì˜ ë¶„ëŸ‰ê³¼ í˜•ì‹ì— ë§ì¶° ìì—°ìŠ¤ëŸ½ê²Œ ì§ˆë¬¸í˜•ìœ¼ë¡œ ë§ˆë¬´ë¦¬
        

        ì˜ˆì‹œ:
        "í˜¹ì‹œ, ë°©ê¸ˆ ë‚˜ëˆˆ ëŒ€í™”ë¥¼ í†µí•´
        'ë‚´ê°€ íŠ¹ì • ìƒí™©ì—ì„œ ë¶ˆì•ˆí•´ì§€ê³ ,
        ê·¸ê²ƒ ë•Œë¬¸ì— ì† ì”»ê¸°ë¥¼ ë°˜ë³µí•˜ëŠ”êµ¬ë‚˜'
        í•˜ê³  ì¡°ê¸ˆ ë” ìê°ì´ ìƒê¸´ ë¶€ë¶„ì´ ìˆì„ê¹Œìš”?"
        """

        # ì‚¬ìš©ì ë©”ì‹œì§€ ìµœê·¼ ë¬¸ë§¥ ì¶”ì¶œ
        user_messages: List[str] = []
        for msg in conversation_history:
            if msg.get("role") == "user":
                content = msg.get("content", "")
                user_messages.append(self._stringify_message_content(content))

        recent_context = " ".join(user_messages[-5:])
        user_prompt = f"ìµœê·¼ ì‚¬ìš©ì ë§¥ë½: {recent_context}"

        try:
            messages = [
                SystemMessage(content=system_prompt),
                HumanMessage(content=user_prompt)
            ]
            response = self.llm.invoke(messages)
            text = response.content.strip()
            return text
        except Exception as e:
            logger.error(f"ê°•ë°• ë¶„ì„5 ì‘ë‹µ ìƒì„± ì¤‘ ì˜¤ë¥˜: {e}")
            fallback = (
                "í˜¹ì‹œ, ë°©ê¸ˆ ë‚˜ëˆˆ ëŒ€í™”ë¥¼ ëŒì•„ë³´ë©´ íŠ¹ì • ìƒí™©ì—ì„œ ë¶ˆì•ˆì´ ì˜¬ë¼ì˜¤ê³ , "
                "ê·¸ ë¶ˆì•ˆì„ ë‹¬ë˜ê¸° ìœ„í•´ ì–´ë–¤ í–‰ë™ì„ ë°˜ë³µí•˜ê²Œ ë˜ëŠ” íë¦„ì´ ë³´ì¼ê¹Œìš”? "
                "ì¡°ê¸ˆ ë” ìê°ì´ ìƒê¸´ ë¶€ë¶„ì´ ìˆì„ê¹Œìš”?"
            )
            return fallback

    def generate_obsession_analysis6_response(self, conversation_history: List[Dict[str, Any]]) -> str:
        """
        ì‚¬ìš©ìì˜ ìµœê·¼ ëŒ€í™”ë¥¼ ë°”íƒ•ìœ¼ë¡œ 'ì•Œì•„ê°€ëŠ” ê²ƒì´ ì¤‘ìš”í•˜ë‹¤, í•¨ê»˜ ì—°ìŠµí•  ìˆ˜ ìˆë‹¤'ëŠ”
        ë©”ì‹œì§€ë¥¼ LLMìœ¼ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ ìƒì„±í•˜ê³ , ê³ ì • ë¬¸ì¥ì„ í›„í–‰ìœ¼ë¡œ ë¶™ì—¬ ë°˜í™˜í•©ë‹ˆë‹¤.
        ê³ ì • ë¬¸ì¥: "ë¨¼ì €, ì–´ë–¤ ìƒí™©ì´ íŠ¹íˆ ë¶ˆì•ˆí–ˆëŠ”ì§€\nì •ë¦¬í•˜ë©° ì‹œì‘í•´ë³¼ê¹Œìš”?"
        """
        system_prompt = (
            "ë‹¹ì‹ ì€ ê²½í—˜ ë§ì€ ìƒë‹´ê°€ì…ë‹ˆë‹¤.\n"
            "ì‚¬ìš©ìì˜ ìµœê·¼ ëŒ€í™”ë¥¼ ë°”íƒ•ìœ¼ë¡œ, ì‚¬ìš©ìê°€ ìì‹ ì˜ ë¶ˆì•ˆì„ 'ì¸ì‹í•˜ê³  ì•Œì•„ê°€ëŠ” ê²ƒì´ ì¤‘ìš”í•˜ë‹¤'ëŠ” ë©”ì‹œì§€ë¥¼ ëŠë‚„ ìˆ˜ ìˆë„ë¡ ë•ëŠ” ë¬¸ì¥ì„ ì‘ì„±í•´ì£¼ì„¸ìš”."
            "ê·œì¹™: ì˜ˆì‹œì˜ ë¶„ëŸ‰ê³¼ í˜•ì‹ì— ë§ì¶° ìì—°ìŠ¤ëŸ½ê²Œ ì‘ì„±í•˜ë˜ ë§ˆì§€ë§‰ì—ëŠ” ì§ˆë¬¸ì„ ë¶™ì´ì§€ ë§ê¸°"

            "ì˜ˆì‹œ:ê·¸ ì¸ì‹ì´ ì •ë§ ì¤‘ìš”í•´ìš” ğŸ‘ ì´ì œ ìš°ë¦¬ê°€ í•¨ê»˜ ê·¸ ë¶ˆì•ˆì„ ì¡°ê¸ˆì”© ì¤„ì´ëŠ” ì—°ìŠµì„ ì‹œì‘í•´ë³¼ ìˆ˜ ìˆì–´ìš”. " 
        )

        # ìµœê·¼ ì‚¬ìš©ì ë§¥ë½ ìƒì„±
        user_messages: List[str] = []
        for msg in conversation_history:
            if msg.get("role") == "user":
                content = msg.get("content", "")
                user_messages.append(self._stringify_message_content(content))

        recent_context = " ".join(user_messages[-5:])
        user_prompt = f"ìµœê·¼ ì‚¬ìš©ì ë§¥ë½: {recent_context}"

        closing_fixed = (
            "ë¨¼ì €, ì–´ë–¤ ìƒí™©ì´ íŠ¹íˆ ë¶ˆì•ˆí–ˆëŠ”ì§€ ì •ë¦¬í•˜ë©° ì‹œì‘í•´ë³¼ê¹Œìš”?"
        )

        try:
            messages = [
                SystemMessage(content=system_prompt),
                HumanMessage(content=user_prompt),
            ]
            response = self.llm.invoke(messages)
            intro = response.content.strip()

            return f"{intro}\n\n{closing_fixed}"
        except Exception as e:
            logger.error(f"ê°•ë°• ë¶„ì„6 ì‘ë‹µ ìƒì„± ì¤‘ ì˜¤ë¥˜: {e}")
            fallback_intro = (
                "ì§€ê¸ˆ ëŠë¼ëŠ” ë¶ˆì•ˆì„ ì•Œì•„ì°¨ë¦¬ê³  ë§í•´ì£¼ëŠ” ê²ƒ ìì²´ê°€ í° ì‹œì‘ì´ì—ìš”. "
                "ìš°ë¦¬ëŠ” ê·¸ ê³¼ì •ì„ í•¨ê»˜ ì²œì²œíˆ ì—°ìŠµí•´ë³¼ ìˆ˜ ìˆì–´ìš”."
            )
            return f"{fallback_intro}\n\n{closing_fixed}"